# Анализ доступных коллекций 1C УНФ ФРЕШ

## Обзор

Данный документ содержит анализ доступных коллекций OData из 1C УНФ ФРЕШ для интеграции с платформой аналитики.

## Основные коллекции для продаж

### 1. AccumulationRegister_Продажи / AccumulationRegister_Продажи_RecordType
**Текущее использование:** ✅ Используется для получения детальных данных о продажах

**Описание:**
- Регистр накопления продаж
- Содержит детальную информацию о каждой продаже
- Поля: `Period`, `Склад_Key`, `Номенклатура_Key`, `Контрагент_Key`, `Сумма`, `Количество`, `Документ`, и др.

**Использование:**
- Получение продаж по магазинам (Склад_Key)
- Получение продаж по товарам (Номенклатура_Key)
- Получение продаж по клиентам (Контрагент_Key)
- Разбивка по дням (Period)

### 2. DocumentJournal_РозничныеПродажи
**Текущее использование:** ⚠️ Ранее использовался, сейчас заменен на AccumulationRegister_Продажи_RecordType

**Описание:**
- Журнал документов розничных продаж
- Содержит документы продаж (чеки)

**Примечание:** Менее детальный, чем RecordType, но может быть полезен для получения списка документов продаж.

## Коллекции для клиентов

### 3. Catalog_ДисконтныеКарты
**Текущее использование:** ✅ Используется для получения данных о дисконтных картах

**Описание:**
- Каталог дисконтных карт
- Номер карты = номер телефона = логин для входа на сайт

### 4. Catalog_Контрагенты
**Текущее использование:** ✅ Используется для получения профилей клиентов

**Описание:**
- Каталог контрагентов (клиентов)
- Содержит полную информацию о клиентах

### 5. AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType
**Текущее использование:** ✅ Используется для получения продаж по дисконтным картам

**Описание:**
- Регистр продаж по дисконтным картам
- Полезен для анализа продаж по клиентам с картами

## Коллекции для товаров

### 6. Catalog_Номенклатура
**Текущее использование:** ⚠️ Частично используется (product_id сохраняется, но детали товара не синхронизируются)

**Описание:**
- Каталог номенклатуры (товаров)
- Содержит информацию о товарах: название, артикул, цена, категория и т.д.

**Рекомендация:** Добавить синхронизацию каталога товаров для детального анализа продаж по товарам.

### 7. Catalog_Склады
**Текущее использование:** ⚠️ Частично используется (store_id сохраняется, но детали магазинов не синхронизируются из 1C)

**Описание:**
- Каталог складов (магазинов)
- Содержит информацию о магазинах: название, адрес, и т.д.

**Рекомендация:** Синхронизировать каталог складов для корректного отображения названий магазинов.

## Коллекции для финансового анализа

### 8. AccumulationRegister_ФинансовыйРезультат
**Описание:**
- Регистр финансового результата
- Может быть полезен для анализа прибыли/убытков

### 9. AccountingRegister_Управленческий
**Описание:**
- Управленческий регистр бухгалтерского учета
- Может содержать дополнительную аналитику

## Коллекции для работы с сотрудниками

### 10. AccumulationRegister_ФактическоеРабочееВремяСотрудников
**Описание:**
- Регистр фактического рабочего времени сотрудников
- Может быть полезен для анализа эффективности работы магазинов

## Коллекции для возвратов

### 11. DocumentJournal_Возвраты (если доступен)
**Описание:**
- Журнал документов возвратов
- Полезен для анализа возвратов товаров

**Примечание:** Не видно в предоставленном XML, но может быть доступен через другие коллекции.

## Текущая реализация

### Что уже работает:

1. ✅ **Детальные продажи по магазинам и дням**
   - Используется `AccumulationRegister_Продажи_RecordType`
   - Данные сохраняются в `SalesRecord` с разбивкой по `store_id` (Склад_Key) и `sale_date`
   - Каждая запись содержит `product_id` (Номенклатура_Key) для анализа проданных товаров

2. ✅ **Автоматическая синхронизация**
   - При запросе данных за период, если данных нет в БД, автоматически запускается синхронизация из 1C
   - Данные сохраняются в БД для быстрого доступа

3. ✅ **Онлайн данные за сегодня**
   - Данные за сегодня получаются онлайн из 1C при каждом запросе
   - Объединяются с данными из БД для полной картины

4. ✅ **Сохранение полных данных**
   - В поле `raw_data` (JSON) сохраняются все исходные данные из 1C
   - Это позволяет в дальнейшем извлекать любые дополнительные поля

### Что можно улучшить:

1. ⚠️ **Синхронизация каталога товаров**
   - Добавить синхронизацию `Catalog_Номенклатура` для получения названий товаров, категорий, цен
   - Это позволит делать детальный анализ продаж по товарам

2. ⚠️ **Синхронизация каталога складов**
   - Добавить синхронизацию `Catalog_Склады` для получения названий магазинов из 1C
   - Связать `store_id` (Склад_Key) с нашими магазинами через `external_id`

3. ⚠️ **Анализ возвратов**
   - Если доступен, добавить синхронизацию данных о возвратах
   - Это позволит учитывать возвраты в аналитике

4. ⚠️ **Финансовый анализ**
   - Рассмотреть использование `AccumulationRegister_ФинансовыйРезультат` для анализа прибыльности

## Рекомендации по использованию

### Для продаж:
- **Основной источник:** `AccumulationRegister_Продажи_RecordType` ✅
- **Дополнительно:** `DocumentJournal_РозничныеПродажи` (для списка документов)

### Для клиентов:
- **Профили:** `Catalog_Контрагенты` ✅
- **Дисконтные карты:** `Catalog_ДисконтныеКарты` ✅
- **История покупок:** `AccumulationRegister_Продажи_RecordType` (фильтр по Контрагент_Key) ✅

### Для товаров:
- **Детали товаров:** `Catalog_Номенклатура` ⚠️ (рекомендуется добавить)
- **Продажи по товарам:** `AccumulationRegister_Продажи_RecordType` (фильтр по Номенклатура_Key) ✅

### Для магазинов:
- **Детали магазинов:** `Catalog_Склады` ⚠️ (рекомендуется добавить)
- **Продажи по магазинам:** `AccumulationRegister_Продажи_RecordType` (фильтр по Склад_Key) ✅

## Структура данных в БД

### SalesRecord (детальные записи продаж)
- `sale_date` - дата продажи (из Period)
- `store_id` - ID магазина (из Склад_Key)
- `product_id` - ID товара (из Номенклатура_Key)
- `customer_id` - ID клиента (из Контрагент_Key)
- `revenue` - выручка (из Сумма)
- `quantity` - количество (из Количество)
- `raw_data` - полные данные из 1C (JSON)

### Индексы для быстрого поиска:
- По дате и магазину: `ix_sales_records_date_store`
- По дате и клиенту: `ix_sales_records_date_customer`
- По дате и товару: `ix_sales_records_date_product`

## Заключение

Текущая реализация уже обеспечивает:
- ✅ Получение продаж по каждому магазину с разбивкой по дням
- ✅ Сохранение всех продаж в локальной БД
- ✅ Запись проданных товаров (product_id) для дальнейшего анализа
- ✅ Автоматическую синхронизацию при отсутствии данных

Рекомендуется добавить синхронизацию каталогов товаров и складов для более детального анализа.
