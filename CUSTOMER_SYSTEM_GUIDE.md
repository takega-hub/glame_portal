# Руководство по системе работы с покупателями GLAME

## Обзор

Система работы с покупателями GLAME обеспечивает полный цикл взаимодействия с клиентами: от синхронизации из 1С до персонализированных маркетинговых кампаний через AI.

## Архитектура

### Backend

#### Модели данных

1. **User** (расширена) - основная модель пользователя/покупателя
   - Поля для покупателей: `phone`, `discount_card_number`, `customer_id_1c`, `loyalty_points`, `total_purchases`, `total_spent`, `rfm_score`, `purchase_preferences`
   - Роли: `customer`, `admin`, `ai_marketer`, `content_manager`

2. **PurchaseHistory** - история покупок из 1С
   - Связь с пользователем и товарами
   - Данные о покупках: дата, сумма, товар, категория, бренд

3. **LoyaltyTransaction** - транзакции баллов лояльности
   - Типы: `earn`, `spend`, `expire`, `bonus`, `manual`
   - История всех операций с баллами

4. **SavedLook** - сохраненные образы покупателей
   - Типы: `favorite` (из каталога) или `generated` (AI сгенерированный)

5. **CustomerSegment** - сегменты покупателей
   - Может быть создан вручную или автоматически через AI
   - Правила сегментации в JSON формате

6. **UserSegment** - связь пользователей с сегментами
   - Множественная принадлежность к сегментам
   - Метка источника назначения: `auto`, `manual`, `ai`

#### Сервисы

1. **CustomerSyncService** (`backend/app/services/customer_sync_service.py`)
   - `sync_discount_cards()` - синхронизация дисконтных карт из 1С
   - `sync_purchase_history()` - синхронизация истории покупок
   - `calculate_customer_metrics()` - расчет метрик (RFM, LTV, предпочтения)
   - `update_customer_segment()` - обновление сегмента покупателя

2. **LoyaltyService** (`backend/app/services/loyalty_service.py`)
   - `calculate_points_for_purchase()` - расчет баллов за покупку
   - `earn_points()` - начисление баллов
   - `spend_points()` - списание баллов
   - `get_loyalty_balance()` - получение баланса
   - `expire_old_points()` - списание просроченных баллов

3. **CustomerAnalyticsService** (`backend/app/services/customer_analytics_service.py`)
   - `get_rfm_analysis()` - RFM анализ
   - `get_ltv_metrics()` - LTV метрики
   - `get_customer_segments_stats()` - статистика по сегментам
   - `get_churn_risk()` - риск оттока
   - `get_top_customers()` - топ покупатели

4. **AISegmentationService** (`backend/app/services/ai_segmentation_service.py`)
   - `auto_segment_customers()` - автоматическая сегментация через LLM
   - `segment_customer()` - сегментация конкретного покупателя
   - `generate_segment_insights()` - AI инсайты по сегменту
   - `predict_next_purchase()` - предсказание следующей покупки

#### API Endpoints

**Аутентификация покупателей:**
- `POST /api/auth/login-by-card` - вход по номеру дисконтной карты
- `POST /api/auth/verify-card` - проверка существования карты
- `POST /api/auth/request-code` - запрос кода подтверждения

**Личный кабинет покупателя:**
- `GET /api/customer/profile` - профиль покупателя
- `PUT /api/customer/profile` - обновление профиля
- `GET /api/customer/purchase-history` - история покупок
- `GET /api/customer/purchase-stats` - статистика покупок
- `GET /api/customer/loyalty` - программа лояльности
- `GET /api/customer/saved-looks` - сохраненные образы
- `POST /api/customer/saved-looks` - сохранить образ
- `DELETE /api/customer/saved-looks/{id}` - удалить сохраненный образ

**Администратор:**
- `GET /api/admin/customers` - список покупателей
- `GET /api/admin/customers/{id}` - детали покупателя
- `PUT /api/admin/customers/{id}` - обновление данных
- `POST /api/admin/customers/{id}/loyalty/adjust` - корректировка баллов
- `GET /api/admin/customers/segments/list` - список сегментов
- `GET /api/admin/customers/analytics/overview` - общая аналитика

**AI Маркетолог:**
- `GET /api/ai-marketer/dashboard` - дашборд с метриками
- `GET /api/ai-marketer/segments/analysis` - анализ сегментов
- `POST /api/ai-marketer/segments/auto-generate` - автосегментация
- `GET /api/ai-marketer/customers/{id}/insights` - инсайты по покупателю
- `POST /api/ai-marketer/campaigns/generate` - генерация кампании
- `GET /api/ai-marketer/opportunities` - поиск возможностей

**Синхронизация с 1С:**
- `POST /api/admin/1c/sync/customers` - синхронизация покупателей
- `POST /api/admin/1c/sync/purchases` - синхронизация покупок
- `GET /api/admin/1c/sync/status` - статус синхронизации

### Frontend

#### Страницы покупателя

1. **`/customer`** - главная страница личного кабинета
   - Карточки быстрого доступа
   - Статистика покупок
   - Информация о сегменте

2. **`/customer/purchases`** - история покупок
   - Фильтры по дате
   - Таблица всех покупок

3. **`/customer/loyalty`** - программа лояльности
   - Баланс баллов
   - История транзакций
   - Уровни программы

4. **`/customer/saved-looks`** - сохраненные образы
   - Вкладки: Избранные / Персональные

5. **`/customer/stylist`** - AI Стилист
   - Персонализированный чат с учетом истории покупок

#### Страницы администратора

1. **`/admin/customers`** - список покупателей
   - Фильтры и поиск
   - Статистика

2. **`/admin/customers/[id]`** - детали покупателя
   - Вкладки: Обзор, История покупок, Лояльность, Образы

3. **`/admin/customers/segments`** - управление сегментами
   - Список сегментов
   - Автосегментация AI

#### Страницы AI Маркетолога

1. **`/ai-marketer`** - дашборд
   - KPI метрики
   - Обзор сегментов
   - AI инсайты и возможности
   - Топ покупатели

2. **`/ai-marketer/segments`** - анализ сегментов
   - Детальный анализ каждого сегмента
   - AI инсайты и рекомендации

3. **`/ai-marketer/campaigns/generate`** - генератор кампаний
   - Выбор сегмента
   - Тип кампании
   - Генерация персонализированного контента

4. **`/ai-marketer/opportunities`** - инсайты и возможности
   - Список обнаруженных возможностей
   - Рекомендации по действиям

## Установка и настройка

### 1. Создание таблиц

```bash
cd backend
python create_customer_tables.py
```

### 2. Настройка переменных окружения

Убедитесь, что в `.env` настроены:

```env
# 1С OData API
ONEC_API_URL=https://msk1.1cfresh.com/a/sbm/3322419/odata/standard.odata
ONEC_API_TOKEN=b2RhdGEudXNlcjpvcGV4b2JvZQ==

# База данных
DB_HOST=localhost
DB_PORT=5433
DB_USER=glame_user
DB_PASSWORD=glame_password
DB_NAME=glame_db
```

### 3. Первоначальная синхронизация

После создания таблиц запустите синхронизацию:

```bash
# Синхронизация покупателей
curl -X POST "http://localhost:8000/api/admin/1c/sync/customers" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# Синхронизация истории покупок
curl -X POST "http://localhost:8000/api/admin/1c/sync/purchases?days=365" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## Использование

### Для покупателей

1. **Вход в систему:**
   - Перейдите на `/login`
   - Выберите вкладку "Для покупателей"
   - Введите номер дисконтной карты (телефон)
   - Введите код подтверждения (последние 4 цифры карты)

2. **Личный кабинет:**
   - Просмотр истории покупок
   - Проверка баланса баллов лояльности
   - Сохранение понравившихся образов
   - Консультация с AI стилистом

### Для администраторов

1. **Управление покупателями:**
   - Просмотр списка всех покупателей
   - Детальная информация по каждому покупателю
   - Ручная корректировка баллов лояльности
   - Управление сегментами

2. **Синхронизация с 1С:**
   - Запуск синхронизации покупателей
   - Запуск синхронизации истории покупок
   - Проверка статуса синхронизации

### Для AI Маркетолога

1. **Дашборд:**
   - Обзор всех метрик
   - Риски оттока
   - Обнаруженные возможности

2. **Сегментация:**
   - Автоматическая сегментация через AI
   - Анализ сегментов
   - AI инсайты и рекомендации

3. **Генерация кампаний:**
   - Выбор сегмента
   - Выбор типа кампании
   - Генерация персонализированного контента

## Программа лояльности

### Правила начисления баллов

- Базовая ставка: **1% от суммы покупки**
- Множители:
  - **x1.5** для VIP клиентов
  - **x1.2** при покупке выше среднего чека на 50%
  - **x2** в день рождения (в течение недели)

### Использование баллов

- 1 балл = 1 рубль скидки
- Минимум 100 баллов для использования
- Баллы не сгорают (кроме специальных бонусных)

## RFM Анализ

Система автоматически рассчитывает RFM scores для каждого покупателя:

- **Recency (R)** - давность последней покупки (1-5)
- **Frequency (F)** - частота покупок (1-5)
- **Monetary (M)** - сумма покупок (1-5)

Общий RFM Score = R + F + M (максимум 15)

## AI Сегментация

Автоматическая сегментация анализирует:
- История покупок
- RFM метрики
- Предпочтения по категориям и брендам
- Поведенческие паттерны

Создает сегменты с правилами и рекомендациями для работы с каждым сегментом.

## Интеграция с 1С

Система синхронизируется с 1С УНФ ФРЕШ через OData API:

- **Дисконтные карты** из `Catalog_ДисконтныеКарты`
- **История покупок** из `AccumulationRegister_Продажи_RecordType`
- **Контрагенты** из `Catalog_Контрагенты`

Рекомендуется настроить автоматическую синхронизацию каждые 30 минут.

## Следующие шаги

1. Настроить автоматическую синхронизацию (cron jobs)
2. Интегрировать SMS сервис для кодов подтверждения
3. Реализовать полную генерацию кампаний через LLM
4. Добавить визуализацию аналитики (графики, тепловые карты)
5. Расширить функционал сохраненных образов (примерка, покупка)
