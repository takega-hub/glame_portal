# Проблемы синхронизации данных покупателей

## Результаты проверки покупателя 79787566405

### Найденные проблемы

#### 1. Баланс бонусов

**Данные в 1С:**
- Остаток бонусов: **4 806** (из интерфейса 1С)
- Последняя запись в регистре: Period=2027-01-16, Начислено=0, КСписанию=4806, RecordType=Expense
- Суммарный баланс всех записей: 5074

**Данные в нашей БД:**
- Loyalty points: **0**

**Проблема:**
- Последняя запись - это списание (Expense), а не остаток
- Нужно использовать остаток из последней записи типа Receipt или использовать другой метод получения остатка
- Возможно, нужно использовать виртуальную таблицу остатков регистра накопления

**Решение:**
- Использовать виртуальную таблицу остатков: `AccumulationRegister_БонусныеБаллы_Остатки`
- Или фильтровать записи по типу (Receipt) и брать последнюю
- Или использовать поле "Остаток" если оно есть в RecordType

#### 2. Сумма продаж

**Данные в 1С:**
- Сумма продаж: **365 054** (из интерфейса 1С)
- Найдено через API: **132,694 руб** за 365 дней, 25 покупок

**Данные в нашей БД:**
- Total spent: **71,276.78 руб**, 25 покупок

**Проблема:**
- Сумма из интерфейса 1С (365 054) не совпадает с суммой из API (132,694)
- Наша БД показывает еще меньше (71,276.78)
- Возможно, в интерфейсе 1С показывается сумма за весь период, а не за 365 дней
- Или используется другой регистр/метод расчета

**Решение:**
- Проверить, какой период используется в интерфейсе 1С
- Использовать DocumentJournal_РозничныеПродажи для получения чеков
- Проверить, правильно ли суммируются записи из AccumulationRegister

#### 3. Структура данных

**Найдено:**
- Дисконтная карта: Ref_Key=b0ed5080-bb1a-11f0-836e-fa163e4cc04e
- Контрагент: Ref_Key=e824f1c0-bb10-11f0-836e-fa163e4cc04e
- Бонусная карта: БонуснаяКарта_Key=b0ed5080-bb1a-11f0-836e-fa163e4cc04e (та же, что и дисконтная)

**Важно:**
- Дисконтная карта и бонусная карта - это одна и та же карта (Ref_Key совпадает)
- Для фильтрации бонусов нужно использовать БонуснаяКарта_Key (не ДисконтнаяКарта_Key)

## Рекомендации

1. **Для баланса бонусов:**
   - Попробовать использовать виртуальную таблицу остатков
   - Или фильтровать по RecordType=Receipt и брать последнюю запись
   - Проверить, есть ли поле "Остаток" в RecordType

2. **Для продаж:**
   - Использовать DocumentJournal_РозничныеПродажи для получения чеков
   - Суммировать суммы чеков, а не записи регистра
   - Проверить период, за который считается сумма в интерфейсе 1С

3. **Для синхронизации:**
   - Убедиться, что используется правильное поле для фильтрации (БонуснаяКарта_Key для бонусов)
   - Проверить, правильно ли конвертируются суммы (рубли/копейки)
   - Добавить логирование для отладки расхождений
