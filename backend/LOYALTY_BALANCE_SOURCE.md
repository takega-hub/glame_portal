# Источник данных для бонусных баллов

## Регистр для получения баланса бонусов

Остаток бонусных баллов берется из регистра накопления 1С:

```
AccumulationRegister_БонусныеБаллы_RecordType
```

### Пример запроса

```
$filter: БонуснаяКарта_Key eq guid'{card_key}'
$orderby: Period desc
$top: 10000
```

### Поля регистра

- `Period` — дата операции
- `Начислено` — количество начисленных баллов (приход)
- `КСписанию` — **остаток доступных баллов** (именно это поле содержит остаток!)
- `БонуснаяКарта_Key` — ID бонусной карты
- `Recorder` — ID документа операции
- `RecordType` — тип записи (Receipt/Expense)

## ⚠️ Важно: Логика расчета остатка

### ❌ Неправильно (старая логика):
```python
balance = Начислено - КСписанию  # Сумма по всем записям
```

### ✅ Правильно (текущая логика):
```python
balance = КСписанию  # Значение из ПОСЛЕДНЕЙ записи (Period desc)
```

## Почему именно "КСписанию"?

В 1С регистр накопления "БонусныеБаллы" работает следующим образом:
- **Начислено** — сколько баллов начислено в данной операции
- **КСписанию** — **текущий остаток** баллов после этой операции (available balance)

Поле "КСписанию" показывает, сколько баллов **доступно для списания** (к использованию).

## Пример данных

Для покупателя с телефоном `79787566405`:

```
Карта: b0ed5080-bb1a-11f0-836e-fa163e4cc04e
Регистр: AccumulationRegister_БонусныеБаллы_RecordType
Фильтр: БонуснаяКарта_Key = guid'b0ed5080-bb1a-11f0-836e-fa163e4cc04e'
Сортировка: Period desc (от новых к старым)

Последняя запись:
- Period: 2027-01-16T00:00:00
- RecordType: Receipt
- Начислено: 0
- КСписанию: 4806  ← это и есть остаток!

Остаток бонусов: 4806 баллов
```

## Реализация в коде

### В `backend/app/services/onec_customers_service.py` (строка 627-657):

```python
# Остаток бонусных баллов = значение поля "КСписанию" из последней записи
# "КСписанию" показывает, сколько баллов доступно для списания (остаток)
# Берем последнюю запись (самую свежую по дате Period)
balance = 0.0
source_id = None

if records:
    # Сортируем по дате Period (если еще не отсортированы)
    last_record = records[0]  # Уже отсортированы по Period desc
    к_списанию = last_record.get("КСписанию") or last_record.get("К списанию") or 0
    try:
        balance = float(к_списанию)
        source_id = (
            last_record.get("Recorder")
            or last_record.get("Документ")
            or last_record.get("Ref_Key")
        )
        logger.info(
            "Остаток бонусов из последней записи (КСписанию): %s",
            int(balance)
        )
    except (TypeError, ValueError):
        logger.warning("Не удалось преобразовать КСписанию в число: %s", к_списанию)
        # Fallback...

return {"balance": int(round(balance)), "source_id": source_id}
```

### В `backend/test_customer_data.py` (строка 186-200):

```python
# Остаток бонусных баллов = значение поля "КСписанию" из последней записи
# "КСписанию" показывает, сколько баллов доступно для списания (остаток)
last_record = records[0] if records else None
balance = 0

if last_record:
    к_списанию = last_record.get("КСписанию") or last_record.get("К списанию") or 0
    начислено = last_record.get("Начислено") or 0
    try:
        balance = float(к_списанию)  # Остаток = значение "КСписанию"
        print(f"\n   [BALANCE] Остаток бонусов (КСписанию): {int(balance)}")
        print(f"      Начислено: {начислено}, К списанию: {к_списанию}")
    except (TypeError, ValueError):
        balance = 0
        print(f"   [ERROR] Не удалось преобразовать КСписанию в число: {к_списанию}")
```

## Проверка

Для проверки используйте тестовый скрипт:

```bash
cd backend
python test_customer_data.py --phone 79787566405
```

Скрипт покажет:
- Остаток бонусов из 1С (из поля "КСписанию" последней записи)
- Остаток бонусов из нашей БД
- Расхождения (если есть)

## История исправлений

**До исправления:**
- Остаток = сумма (Начислено - КСписанию) по всем записям
- Результат: неправильный баланс

**После исправления (текущая версия):**
- Остаток = КСписанию из последней записи (Period desc)
- Результат: **4806 баллов** ✅
