# Changelog - 2026-02-04

## üéØ –ì–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (–º–∏–≥—Ä–∞—Ü–∏—è –∏–∑ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã)

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –ø–æ—Ä—Ç–∞–ª–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–∑ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã (Document_–í–≤–æ–¥–ù–∞—á–∞–ª—å–Ω—ã—Ö–û—Å—Ç–∞—Ç–∫–æ–≤). –°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–ª–∞ —Å 1–°.

**–ü—Ä–∏–º–µ—Ä:**
- 1–°: 365,054 —Ä—É–± (–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ 232,360 + –ø–æ–∫—É–ø–∫–∏ 132,694)
- –ü–æ—Ä—Ç–∞–ª (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è): 132,694 —Ä—É–± ‚ùå
- –ü–æ—Ä—Ç–∞–ª (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è): 365,054 —Ä—É–± ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:**  
–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —ç—Ç–∞–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ `sync_initial_balances()`, –∫–æ—Ç–æ—Ä—ã–π:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–ø–∏—Å–∏ —Ç–∏–ø–∞ `Document_–í–≤–æ–¥–ù–∞—á–∞–ª—å–Ω—ã—Ö–û—Å—Ç–∞—Ç–∫–æ–≤`
- **–ù–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è** –ø–µ—Ä–∏–æ–¥–æ–º (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—É–º–º—É –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ –æ–±—ã—á–Ω—É—é –ø–æ–∫—É–ø–∫—É

---

## üìã –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- **–§–∞–π–ª:** `backend/app/services/customer_sync_service.py`
- **–ú–µ—Ç–æ–¥:** `sync_initial_balances()`
- **–ü—Ä–æ–≥—Ä–µ—Å—Å:** 42-50%
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** `AccumulationRegister_–ü—Ä–æ–¥–∞–∂–∏–ü–æ–î–∏—Å–∫–æ–Ω—Ç–Ω—ã–º–ö–∞—Ä—Ç–∞–º_RecordType` —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `Recorder_Type` —Å–æ–¥–µ—Ä–∂–∏—Ç `–í–≤–æ–¥–ù–∞—á–∞–ª—å–Ω—ã—Ö–û—Å—Ç–∞—Ç–∫–æ–≤`

#### ‚úÖ –ì–æ—Ä–æ–¥ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –ø–æ–ª—è `–û—Å–Ω–æ–≤–Ω—ã–µ–°–≤–µ–¥–µ–Ω–∏—è` (3-—è —Å—Ç—Ä–æ–∫–∞)
- Fallback –Ω–∞ `–°–æ—Å—Ç–∞–≤ ‚Üí –ê–¥—Ä–µ—Å–†–§ ‚Üí –£–ª–∏—Ü–∞`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `city` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∏ –ø–æ–∏—Å–∫–µ

#### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–Ω—ã—Ö –±–∞–ª–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–µ `–ö–°–ø–∏—Å–∞–Ω–∏—é` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `fetch_loyalty_balance()`

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è UI

#### üìä –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **10-40%:** –î–∏—Å–∫–æ–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã
- **42-50%:** –ù–∞—á–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ (–Ω–æ–≤–æ–µ!)
- **55-85%:** –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫
- **90-98%:** –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã
- **100%:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ

#### üîç –ü–æ–∏—Å–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω debounce –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤

#### üêõ –§–∏–∫—Å—ã
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–∫–ª—é—á–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–≤–æ–¥
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ `MissingGreenlet` –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ timezone-aware datetime
- ‚úÖ –ü–æ–∏—Å–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–∞–º –≤–æ –≤—Å–µ—Ö –ø–æ–ª—è—Ö
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—è–º ORM (`getattr`)

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
cd backend
alembic upgrade head
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
cd backend
python sync_db_schema.py
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

#### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST "http://localhost:8000/api/admin/onec/customers/sync/full?limit=1000&days=365" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### –ß–µ—Ä–µ–∑ UI:
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å 1–° ‚Üí –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:
```bash
cd backend
python test_customer_data.py --phone 79788451364
```

#### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
[–ò–¢–û–ì–ò] –û–ë–©–ê–Ø –°–£–ú–ú–ê –ü–û–ö–£–ü–û–ö:
   –ù–∞—á–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ (–ø–µ—Ä–µ–Ω–æ—Å): 232,360.00 —Ä—É–±
   –ü–æ–∫—É–ø–∫–∏ –∑–∞ –≥–æ–¥: 132,694.00 —Ä—É–±
   –ò–¢–û–ì–û: 365,054.00 —Ä—É–± ‚úÖ

[–ò–¢–û–ì–ò] –ö–û–õ–ò–ß–ï–°–¢–í–û –ë–ê–õ–õ–û–í:
   –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã: 4806 –±–∞–ª–ª–æ–≤ ‚úÖ

[–ò–¢–û–ì–ò] –ì–û–†–û–î:
   –ì–æ—Ä–æ–¥: –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å ‚úÖ
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend
- ‚úÖ `backend/app/services/customer_sync_service.py`
  - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `sync_initial_balances()`
  - –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_extract_customer_fields()` (–≥–æ—Ä–æ–¥)

- ‚úÖ `backend/app/api/admin/onec_customers.py`
  - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤—ã–∑–æ–≤ `sync_initial_balances()` –≤ `run_sync_task()`
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

- ‚úÖ `backend/app/services/onec_customers_service.py`
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `fetch_loyalty_balance()` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `–ö–°–ø–∏—Å–∞–Ω–∏—é`)

- ‚úÖ `backend/app/models/user.py`
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `city`

- ‚úÖ `backend/app/api/admin/customers.py`
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã Pydantic –º–æ–¥–µ–ª–∏

### Frontend
- ‚úÖ `frontend/src/app/admin/customers/page.tsx`
  - –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü "–ì–æ—Ä–æ–¥"
  - –û–±–Ω–æ–≤–ª–µ–Ω placeholder –ø–æ–∏—Å–∫–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `backend/SYNC_COMPLETE_GUIDE.md` (–Ω–æ–≤—ã–π)
- ‚úÖ `backend/CHANGELOG_2026_02_04.md` (–Ω–æ–≤—ã–π)
- ‚úÖ `backend/CUSTOMER_SYNC_ISSUES.md`
- ‚úÖ `backend/SYNC_FIXES_SUMMARY.md`
- ‚úÖ `backend/SALES_DATA_SOURCE.md`
- ‚úÖ `backend/LOYALTY_BALANCE_SOURCE.md`

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- ‚úÖ `backend/test_customer_data.py`
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —É–ø–∞–∫–æ–≤–∫–∏
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```
–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –¶–∞—Ä—å–∫–æ–≤–∞ 79788451364
1–°: 365,054 —Ä—É–±
–ü–æ—Ä—Ç–∞–ª: 132,694 —Ä—É–±
–†–∞–∑–Ω–∏—Ü–∞: -232,360 —Ä—É–± ‚ùå
```

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```
–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –¶–∞—Ä—å–∫–æ–≤–∞ 79788451364
1–°: 365,054 —Ä—É–±
–ü–æ—Ä—Ç–∞–ª: 365,054 —Ä—É–±
–†–∞–∑–Ω–∏—Ü–∞: 0 —Ä—É–± ‚úÖ
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:** `backend/SYNC_COMPLETE_GUIDE.md`
- **–ê–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:** `backend/CUSTOMER_DATA_ALGORITHMS_SUMMARY.md`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** `backend/SYNC_FIXES_SUMMARY.md`

---

**–î–∞—Ç–∞:** 2026-02-04  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é ‚úÖ
