# Ожидаемые поля RecordType endpoints (1С УНФ)

## Проблема подключения

Скрипт `test_1c_recordtype_fields.py` не может подключиться к 1С серверу из-за таймаута соединения. Возможные причины:
- Сервер недоступен с текущей сети
- Требуется VPN подключение
- Файрвол блокирует соединение
- Проблемы с SSL/TLS сертификатом

## Ожидаемая структура полей

На основе типичной структуры 1С УНФ и OData метаданных, вот какие поля мы ожидаем найти:

### 1. AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType

**Реальные поля (проверено):**
- `Period` - период регистрации (дата продажи)
- `Recorder` - ссылка на записывающий документ
- `Recorder_Type` - тип записывающего документа
- `LineNumber` - номер строки
- `Active` - активность записи
- `ДисконтнаяКарта_Key` ✅ - ссылка на дисконтную карту (правильное поле для фильтрации)
- `Номенклатура_Key` - ссылка на товар
- `Характеристика_Key` - ссылка на характеристику товара
- `ВладелецКарты_Key` - ссылка на владельца карты (покупателя)
- `Количество` - количество товара
- `Сумма` - сумма продажи
- `Скидка` - размер скидки
- `ДисконтнаяКарта@navigationLinkUrl` - навигационная ссылка
- `Номенклатура@navigationLinkUrl` - навигационная ссылка
- `ВладелецКарты@navigationLinkUrl` - навигационная ссылка

**Использование:**
```python
# Фильтр по дисконтной карте
filter_query = f"ДисконтнаяКарта_Key eq guid'{card_id}'"
# или
filter_query = f"Карта_Key eq guid'{card_id}'"
```

### 2. AccumulationRegister_БонусныеБаллы_RecordType

**Реальные поля (проверено):**
- `Period` - период регистрации
- `Recorder` - ссылка на записывающий документ
- `Recorder_Type` - тип записывающего документа
- `LineNumber` - номер строки
- `Active` - активность записи
- `RecordType` - тип записи
- `БонуснаяКарта_Key` ✅ - ссылка на бонусную карту (правильное поле для фильтрации)
- `Начислено` ✅ - количество начисленных баллов
- `КСписанию` ✅ - количество баллов к списанию
- `ДатаПервоначальногоНачисления` - дата первоначального начисления
- `БонуснаяКарта@navigationLinkUrl` - навигационная ссылка

**Использование:**
```python
# Получить текущий остаток баллов
# Баланс = Начислено - КСписанию
filter_query = f"БонуснаяКарта_Key eq guid'{card_id}'"
# Сортировка по периоду для получения последнего остатка
orderby = "Period desc"
```

### 3. AccumulationRegister_НачисленияБонусныхБаллов_RecordType

**Реальные поля (проверено):**
- `Period` - период регистрации
- `Recorder` - ссылка на записывающий документ
- `Recorder_Type` - тип записывающего документа
- `LineNumber` - номер строки
- `Active` - активность записи
- `БонуснаяКарта_Key` ✅ - ссылка на бонусную карту (правильное поле для фильтрации)
- `Номенклатура_Key` - ссылка на товар
- `Характеристика_Key` - ссылка на характеристику товара
- `БонуснаяПрограмма_Key` - ссылка на программу лояльности
- `ВладелецКарты_Key` ✅ - ссылка на владельца карты (покупателя)
- `АналитикаНачисленияБонусов` - аналитика начисления
- `АналитикаНачисленияБонусов_Type` - тип аналитики
- `Сумма` ✅ - сумма операции (начисление/списание)
- `БонуснаяКарта@navigationLinkUrl` - навигационная ссылка
- `Номенклатура@navigationLinkUrl` - навигационная ссылка
- `Характеристика@navigationLinkUrl` - навигационная ссылка
- `БонуснаяПрограмма@navigationLinkUrl` - навигационная ссылка
- `ВладелецКарты@navigationLinkUrl` - навигационная ссылка

**Использование:**
```python
# Получить все начисления за период
filter_query = f"БонуснаяКарта_Key eq guid'{card_id}' and Period ge datetime'{start_date}'"
# или по владельцу карты
filter_query = f"ВладелецКарты_Key eq guid'{customer_id}' and Period ge datetime'{start_date}'"
```

## Гибкая настройка фильтров

В `onec_customers_service.py` реализована гибкая система фильтров через переменные окружения:

```env
# Поля для фильтрации продаж по карте (через запятую, пробуются по порядку)
# ✅ ДисконтнаяКарта_Key - правильное поле (проверено)
ONEC_SALES_BY_CARD_FILTER_FIELDS=ДисконтнаяКарта_Key,ДисконтнаяКарта,Карта_Key,Карта

# Поля для фильтрации баллов лояльности
# ✅ БонуснаяКарта_Key - правильное поле для AccumulationRegister_БонусныеБаллы_RecordType (проверено)
ONEC_LOYALTY_FILTER_FIELDS=БонуснаяКарта_Key,ДисконтнаяКарта_Key,ВладелецКарты_Key,Контрагент_Key,Покупатель_Key
```

Система автоматически пробует каждое поле по очереди, пока не найдет рабочее.

## ✅ Поля проверены и обновлены

1. **Подключение к 1С работает:**
   ```bash
   cd backend
   .\venv\Scripts\python.exe test_1c_recordtype_fields.py
   ```

2. **Скрипт успешно получил список полей:**
   - ✅ Все поля для каждого endpoint определены
   - ✅ Код обновлен с правильными именами полей
   - ✅ Документация обновлена

3. **Обновления внесены:**
   - ✅ `ONEC_SALES_BY_CARD_FILTER_FIELDS` - использует `ДисконтнаяКарта_Key` (правильное поле)
   - ✅ `ONEC_LOYALTY_FILTER_FIELDS` - использует `БонуснаяКарта_Key` (правильное поле)
   - ✅ `_extract_balance_value()` - обновлен для работы с `Начислено` и `КСписанию`
   - ✅ `fetch_loyalty_balance()` - обновлен для работы с `БонуснаяКарта_Key`

## Альтернативный способ проверки

Если у вас есть доступ к 1С через браузер, вы можете проверить структуру напрямую:

1. Откройте в браузере:
   ```
   https://msk1.1cfresh.com/a/sbm/3322419/odata/standard.odata/AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType?$top=1
   ```

2. Введите логин/пароль при запросе (или используйте токен в заголовке Authorization)

3. Вы увидите JSON с одной записью и всеми доступными полями

## ✅ Следующие шаги (выполнено)

1. ✅ **Подключение к 1С проверено:**
   - Сервер доступен
   - VPN отключен (не требуется)
   - Подключение работает

2. ✅ **Тест полей выполнен:**
   ```bash
   cd backend
   .\venv\Scripts\python.exe test_1c_recordtype_fields.py
   ```
   - Все поля получены и задокументированы

3. ✅ **Конфигурация обновлена:**
   - Код обновлен с правильными именами полей
   - Документация обновлена
   - `.env` примеры обновлены

4. **Протестируйте синхронизацию:**
   ```bash
   cd backend
   .\venv\Scripts\python.exe run_customer_sync_once.py
   ```
   - Теперь синхронизация должна работать с правильными полями
