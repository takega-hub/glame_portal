# Источник данных о продажах

## Регистр для получения продаж

Сумма продаж покупателя берется из регистра накопления 1С:

```
AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType
```

### Пример запроса

```
$filter: ДисконтнаяКарта_Key eq guid'{discount_card_key}'
$orderby: Period desc
$top: 10000
```

### Поля регистра

- `Period` — дата продажи
- `Сумма` — сумма покупки (в рублях)
- `Количество` — количество товара
- `Номенклатура_Key` — ID товара
- `ДисконтнаяКарта_Key` — ID дисконтной карты
- `ВладелецКарты_Key` — ID владельца карты (контрагент)
- `Recorder` — ID документа продажи
- `Recorder_Type` — тип документа (обычно `StandardODATA.Document_ОтчетОРозничныхПродажах`)

## Логика синхронизации

В `backend/app/services/customer_sync_service.py`:

### 1. Приоритет: По дисконтной карте

```python
purchases = await onec_service.fetch_sales_by_discount_card(
    discount_card_key=discount_card_id_1c,
    start_date=start_date,
    end_date=end_date,
    limit=10000
)
```

Использует: `AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType`

### 2. Fallback: По контрагенту

Если продажи по карте не найдены:

```python
purchases = await onec_service.get_customer_purchases(
    customer_key=customer_id_1c,
    start_date=start_date,
    end_date=end_date
)
```

Использует: `AccumulationRegister_Продажи_RecordType`

## Пример данных

Для покупателя с телефоном `79787566405`:

```
Дисконтная карта: b0ed5080-bb1a-11f0-836e-fa163e4cc04e
Регистр: AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType
Фильтр: ДисконтнаяКарта_Key = guid'b0ed5080-bb1a-11f0-836e-fa163e4cc04e'

Результат:
- Найдено продаж: 26
- Общая сумма (за 365 дней): 132,694.00 руб
```

## Расхождения сумм

### Источники данных:

1. **1С UI (интерфейс)**: 365,054 руб
   - Может включать дополнительные документы (возвраты, корректировки)
   - Может использовать другой период

2. **1С API (OData)**: 132,694.00 руб
   - Только `AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType`
   - За последние 365 дней
   - **Это источник для синхронизации**

3. **Наша БД**: зависит от последней синхронизации
   - Обновляется при синхронизации покупателей
   - Может отличаться, если синхронизация давно не выполнялась

## Важно

- ✅ Синхронизация использует правильный регистр `AccumulationRegister_ПродажиПоДисконтнымКартам_RecordType`
- ✅ Данные берутся по дисконтной карте (более точно, чем по контрагенту)
- ✅ Регистр содержит детальную информацию о каждой покупке
- ✅ Можно привязать товары к каталогу GLAME по артикулу

## Проверка

Для проверки используйте тестовый скрипт:

```bash
cd backend
python test_customer_data.py --phone 79788451364
```

Скрипт покажет:
- Сумму из 1С API (из регистра)
- Сумму из нашей БД
- Расхождения (если есть)
