# Руководство по разбивке остатков по складам

## Текущая ситуация

У вас 4 склада в 1С:
- 3 магазина (розничные точки)
- 1 основной склад

## Что было сделано

### 1. Обновлён сервис синхронизации остатков

**Файл:** `backend/app/services/onec_stock_service.py`

Сервис теперь:
- ✅ Использует разбивку остатков по складам из `offers.xml`, если она есть
- ✅ Создаёт отдельные записи в `product_stocks` для каждого склада
- ✅ Сохраняет статистику по найденным складам

### 2. Структура данных

**Таблица `product_stocks`:**
- `product_id` - UUID товара из каталога
- `store_id` - ID склада из 1С (Склад_Key)
- `quantity` - Количество на складе
- `available_quantity` - Доступное количество
- `reserved_quantity` - Зарезервированное количество

**Уникальный индекс:** `(product_id, store_id)` - один товар может иметь остатки на нескольких складах

## Проверка структуры offers.xml

Запустите скрипт для проверки:

```bash
python backend\check_offers_xml_structure.py
```

Скрипт покажет:
- Есть ли в `offers.xml` разбивка остатков по складам
- Какие склады найдены
- Примеры структуры данных

## Варианты работы с остатками

### Вариант 1: Разбивка в offers.xml (рекомендуется)

Если в `offers.xml` есть элементы `<Склад>` с атрибутами:
- `ИдСклада` - ID склада
- `КоличествоНаСкладе` - количество на складе

**Пример структуры:**
```xml
<Предложение>
  <Ид>товар-id</Ид>
  <Количество>10</Количество>
  <Склад ИдСклада="склад-1" КоличествоНаСкладе="5"/>
  <Склад ИдСклада="склад-2" КоличествоНаСкладе="3"/>
  <Склад ИдСклада="склад-3" КоличествоНаСкладе="2"/>
</Предложение>
```

**Что делать:**
1. Настроить 1С для экспорта остатков по складам в `offers.xml`
2. Сервис автоматически будет использовать эти данные
3. Остатки будут разбиты по складам автоматически

### Вариант 2: Распределение пропорционально продажам

Если в `offers.xml` нет разбивки по складам, можно использовать сервис распределения:

**Файл:** `backend/app/services/stock_distribution_service.py`

**Метод:** `distribute_stocks_by_sales()`

Распределяет остатки пропорционально продажам по складам за период.

**Пример использования:**
```python
from app.services.stock_distribution_service import StockDistributionService

service = StockDistributionService(db)
distribution = await service.distribute_stocks_by_sales(
    product_id="товар-id-из-1с",
    total_quantity=100.0,
    period_days=90  # Анализировать продажи за 90 дней
)
# Результат: {"склад-1": 50.0, "склад-2": 30.0, "склад-3": 20.0}
```

### Вариант 3: Склад по умолчанию (текущее поведение)

Если нет разбивки по складам, остатки сохраняются на склад `"default_store"`.

Это используется для обратной совместимости.

## Получение складов из продаж

В продажах уже есть поле `Склад_Key` - это ID склада из 1С.

**Проверка:**
```bash
python backend\check_1c_stocks_and_stores.py
```

Скрипт покажет:
- Какие склады используются в продажах
- Структуру данных по складам

## Синхронизация складов

**Сервис:** `backend/app/services/onec_stores_service.py`

**Эндпоинт 1С:** `/Catalog_Склады`

**Что делать:**
1. Синхронизировать склады из 1С (если доступен каталог)
2. Или использовать склады из продаж (поле `Склад_Key`)

## Рекомендации

### 1. Настройка 1С

**Идеальный вариант:** Настроить экспорт остатков по складам в `offers.xml`

В настройках обмена 1С нужно:
- Включить экспорт остатков по складам
- Указать, какие склады экспортировать (3 магазина + основной склад)

### 2. Проверка данных

После синхронизации остатков проверьте:

```sql
-- Посмотреть остатки по складам
SELECT 
    ps.store_id,
    COUNT(*) as products_count,
    SUM(ps.quantity) as total_quantity
FROM product_stocks ps
GROUP BY ps.store_id
ORDER BY ps.store_id;
```

### 3. Использование в аналитике

Остатки по складам уже используются в:
- `ProductTurnoverService` - расчёт оборачиваемости
- Аналитике продаж по магазинам

## Следующие шаги

1. **Запустить проверку структуры offers.xml:**
   ```bash
   python backend\check_offers_xml_structure.py
   ```

2. **Если разбивки нет - настроить 1С** для экспорта остатков по складам

3. **Или использовать распределение** пропорционально продажам (если нужно)

4. **Синхронизировать остатки:**
   - Через API: `POST /api/products/sync-stocks`
   - Или через скрипт: `backend/scripts/sync_stocks_nightly.py`

## Вопросы для уточнения

1. Есть ли в вашем `offers.xml` разбивка остатков по складам?
2. Какие ID складов используются в продажах (поле `Склад_Key`)?
3. Нужно ли различать основной склад и магазины в системе?
