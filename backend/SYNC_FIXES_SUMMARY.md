# Исправления синхронизации данных покупателей

## Исправленные проблемы

### 1. Баланс бонусов

**Проблема:**
- В 1С показывается остаток 4 806 баллов
- В нашей БД: 0 баллов
- Последняя запись в регистре - это списание (Expense), а не остаток

**Исправления:**
- Добавлена попытка использовать виртуальную таблицу остатков `AccumulationRegister_БонусныеБаллы_Остатки`
- Исправлен расчет баланса: теперь суммируем все записи правильно (Начислено - КСписанию)
- Увеличен лимит записей с 1000 до 10000 для получения всех записей
- Добавлена сортировка по Period desc для правильного порядка записей
- Добавлено детальное логирование для отладки

**Файлы:**
- `backend/app/services/onec_customers_service.py` - метод `fetch_loyalty_balance()`

### 2. Сумма продаж

**Проблема:**
- В 1С интерфейсе: 365 054 руб (за весь период)
- Через API за 365 дней: 132,694 руб, 25 покупок
- В нашей БД: 71,276.78 руб, 25 покупок

**Исправления:**
- Увеличен лимит записей с 1000 до 10000 для получения всех покупок
- Добавлено логирование для отладки конвертации сумм
- Улучшена обработка сумм в методе `_to_kopecks()`

**Примечание:**
- Возможно, в 1С интерфейсе показывается сумма за весь период, а не за 365 дней
- Для полного совпадения может потребоваться синхронизация за весь период или использование другого endpoint

**Файлы:**
- `backend/app/services/customer_sync_service.py` - метод `sync_purchase_history()`
- `backend/app/services/onec_customers_service.py` - метод `fetch_sales_by_discount_card()`

### 3. Поиск покупателей

**Проблема:**
- Поиск не работал - не находил покупателей по вхождениям

**Исправления:**
- Исправлено использование `ilike` - теперь используется прямое обращение к атрибутам модели
- Добавлена обработка пустого поиска (trim)
- Добавлен debounce на фронтенде (500мс) для оптимизации запросов
- Добавлено логирование для отладки

**Файлы:**
- `backend/app/api/admin/customers.py` - endpoint `get_customers()`
- `frontend/src/app/admin/customers/page.tsx` - компонент поиска

## Изменения в коде

### Backend

1. **`backend/app/services/onec_customers_service.py`:**
   - Метод `fetch_loyalty_balance()`:
     - Добавлена попытка использовать виртуальную таблицу остатков
     - Исправлен расчет баланса (сумма всех начислений минус сумма всех списаний)
     - Увеличен лимит до 10000 записей
     - Добавлено детальное логирование

2. **`backend/app/services/customer_sync_service.py`:**
   - Метод `sync_purchase_history()`:
     - Увеличен лимит до 10000 покупок
     - Добавлено логирование для отладки
   - Метод `_to_kopecks()`:
     - Улучшена обработка сумм
     - Добавлены комментарии

3. **`backend/app/api/admin/customers.py`:**
   - Endpoint `get_customers()`:
     - Исправлен поиск - используется прямое обращение к атрибутам модели
     - Добавлена обработка пустого поиска
     - Добавлено логирование

### Frontend

1. **`frontend/src/app/admin/customers/page.tsx`:**
   - Добавлен debounce для поиска (500мс)
   - Добавлена проверка на пустой поиск
   - Исправлено дублирование вызовов `loadCustomers()`

## Переменные окружения

Добавлена новая переменная (опционально):
```env
ONEC_LOYALTY_BALANCES_ENDPOINT=/AccumulationRegister_БонусныеБаллы_Остатки
```

## Следующие шаги

1. **Протестировать синхронизацию:**
   - Запустить синхронизацию для конкретного покупателя (79787566405)
   - Проверить, что баланс бонусов теперь синхронизируется правильно
   - Проверить, что сумма продаж синхронизируется правильно

2. **Проверить виртуальную таблицу остатков:**
   - Если виртуальная таблица остатков доступна, она будет использоваться
   - Если нет, используется расчет из RecordType

3. **Оптимизировать синхронизацию продаж:**
   - Возможно, нужно синхронизировать за весь период, а не только за 365 дней
   - Или использовать другой endpoint для получения суммы продаж

4. **Мониторинг:**
   - Проверить логи после синхронизации
   - Убедиться, что данные совпадают с 1С

## Тестирование

Для тестирования используйте скрипт:
```bash
cd backend
.\venv\Scripts\python.exe test_customer_data.py
```

Скрипт проверит данные конкретного покупателя и покажет расхождения.
