# Интеграция с 1С - Загрузка и обновление каталога товаров

## Обзор

Платформа GLAME поддерживает синхронизацию данных с системой 1С УНФ FRESH:

- **Каталог товаров**: Только через CommerceML XML (`import.xml`)
- **Цены и остатки**: Только через CommerceML XML (`offers.xml`)
- **Покупатели и продажи**: Через OData API

**Важно:** Все методы синхронизации товаров, цен и остатков через OData API удалены. Используется только CommerceML XML.

## Синхронизация каталога товаров

### CommerceML XML (основной метод)

**Стандартный способ выгрузки из 1С УНФ** через встроенный механизм обмена данными.

#### Настройка в 1С

1. Откройте 1С УНФ FRESH
2. Настройте выгрузку каталога в формате CommerceML XML
3. Разместите файлы по доступному HTTP URL:
   - **`import.xml`** - основной файл с каталогом товаров (обязательно)
   - **`offers.xml`** - файл с ценами и остатками (опционально, загружается автоматически)

**Важно:** В UI указывайте только URL к `import.xml`. Файл `offers.xml` будет загружен автоматически из той же папки, если доступен.

#### Синхронизация через API

```bash
curl -X POST "http://localhost:8000/api/products/sync-xml" \
  -H "Content-Type: application/json" \
  -d '{
    "xml_url": "https://your-server.com/1c_exchange/uploaded/import.xml",
    "update_existing": true,
    "async_mode": true
  }'
```

**Параметры:**
- `xml_url` (string, обязательно) - URL для скачивания `import.xml` файла
  - Пример: `https://your-server.com/1c_exchange/uploaded/import.xml`
  - Файл `offers.xml` будет загружен автоматически из той же папки
- `update_existing` (bool, default: true) - Обновлять существующие товары
- `async_mode` (bool, default: true) - Асинхронный режим с отслеживанием прогресса

**Примечание:** Если `offers.xml` недоступен, синхронизация продолжится без цен и остатков. Товары будут загружены с нулевой ценой, которую можно обновить позже.

**Ответ (async_mode=true):**
```json
{
  "status": "started",
  "message": "Синхронизация из XML запущена в фоновом режиме",
  "task_id": "uuid-задачи",
  "status_url": "/api/products/sync-1c/status?task_id=uuid-задачи"
}
```

**Ответ (async_mode=false):**
```json
{
  "status": "success",
  "message": "Синхронизация из XML завершена",
  "products": {
    "total": 150,
    "created": 10,
    "updated": 120,
    "skipped": 20,
    "errors": [],
    "error_count": 0
  }
}
```

#### Проверка статуса

```bash
curl -X GET "http://localhost:8000/api/products/sync-1c/status?task_id=uuid-задачи"
```

**Ответ:**
```json
{
  "task_id": "uuid-задачи",
  "task_type": "products_xml",
  "status": "running",
  "progress": 45,
  "current": 68,
  "total": 150,
  "stage": "import",
  "stage_description": "Импорт товара 68 из 150",
  "created_at": "2026-02-04T12:00:00",
  "completed_at": null,
  "result": null,
  "error": null
}
```

#### Формат CommerceML XML

CommerceML - это стандартный XML формат обмена данными между 1С и интернет-магазинами. Файл содержит:

**Структура:**
```xml
<КоммерческаяИнформация xmlns="urn:1C.ru:commerceml_210">
  <Классификатор>
    <Группы>
      <Группа>
        <Ид>uuid</Ид>
        <Наименование>Название группы</Наименование>
      </Группа>
    </Группы>
  </Классификатор>
  <Каталог>
    <Товары>
      <Товар>
        <Ид>uuid</Ид>
        <Артикул>AG25145</Артикул>
        <Код>НФ-00002478</Код>
        <Наименование>Название товара</Наименование>
        <Группы>
          <Ид>uuid-группы</Ид>
        </Группы>
      </Товар>
    </Товары>
  </Каталог>
</КоммерческаяИнформация>
```

**Парсятся следующие элементы:**

- **Группы каталога** (из `Классификатор → Группы → Группа`):
  - `Ид` - уникальный идентификатор группы
  - `Наименование` - название группы
  - Поддерживается вложенность групп

- **Товары** (из `Каталог → Товары → Товар`):
  - `Ид` - уникальный идентификатор товара
  - `Артикул` - артикул товара
  - `Код` - внутренний код 1С
  - `Наименование` - название товара
  - `Описание` - описание товара
  - `Группы → Ид` - ссылка на группу каталога
  - `Штрихкод` - штрихкод товара
  - `ЗначенияСвойств` - характеристики товара (сохраняются в `specifications`)
  - `ЗначенияРеквизитов` - дополнительные реквизиты

- **Предложения** (`Предложение`) с ценами:
  - `Ид` - ссылка на товар
  - `Цены/Цена/ЦенаЗаЕдиницу` - цена товара

#### Пример структуры CommerceML

```xml
<?xml version="1.0" encoding="UTF-8"?>
<КоммерческаяИнформация>
  <Каталог>
    <Товары>
      <Товар>
        <Ид>550e8400-e29b-41d4-a716-446655440001</Ид>
        <Артикул>AG25055-G</Артикул>
        <Наименование>Браслет Crystal в стиле диско</Наименование>
        <Описание>Изысканный браслет от AGafi</Описание>
        <Группы>
          <Ид>necklace-group</Ид>
        </Группы>
        <Картинка>https://example.com/image1.jpg</Картинка>
        <ХарактеристикиТовара>
          <ХарактеристикаТовара>
            <Наименование>Материал</Наименование>
            <Значение>Серебро</Значение>
          </ХарактеристикаТовара>
          <ХарактеристикаТовара>
            <Наименование>Цвет</Наименование>
            <Значение>Золотой</Значение>
          </ХарактеристикаТовара>
        </ХарактеристикиТовара>
      </Товар>
    </Товары>
  </Каталог>
  <ПакетПредложений>
    <Предложения>
      <Предложение>
        <Ид>550e8400-e29b-41d4-a716-446655440001</Ид>
        <Цены>
          <Цена>
            <ЦенаЗаЕдиницу>5590.00</ЦенаЗаЕдиницу>
          </Цена>
        </Цены>
      </Предложение>
    </Предложения>
  </ПакетПредложений>
</КоммерческаяИнформация>
```

## Синхронизация покупателей и продаж

Для работы с покупателями и продажами используется **OData API**.

### Настройка OData API

Добавьте переменные окружения в `.env` файл:

```env
# 1C OData API Configuration
ONEC_API_URL=https://msk1.1cfresh.com/a/sbm/3322419/odata/standard.odata
ONEC_API_TOKEN=b2RhdGEudXNlcjpvcGV4b2JvZQ==  # Base64: odata.user:password

# Sales endpoints
ONEC_SALES_ENDPOINT=/DocumentJournal_РозничныеПродажи

# Customer endpoints
ONEC_CUSTOMERS_ENDPOINT=/Catalog_ДисконтныеКарты
```

### API Endpoints

#### Покупатели

```bash
# Синхронизация дисконтных карт
POST /api/admin/1c/sync/discount-cards?limit=1000

# Синхронизация истории покупок
POST /api/admin/1c/sync/purchase-history?days=365

# Синхронизация баллов лояльности
POST /api/admin/1c/sync/loyalty-points
```

#### Продажи

```bash
# Синхронизация продаж за период
POST /api/analytics/1c-sales/sync?period=week

# Получение метрик продаж
GET /api/analytics/1c-sales/metrics?period=month&store_id=all

# Получение продаж по дням
GET /api/analytics/1c-sales/daily?start_date=2026-01-01&end_date=2026-01-31
```

**Доступные периоды:**
- `today` - Сегодня
- `yesterday` - Вчера
- `week` - Неделя
- `month` - Месяц
- `quarter` - Квартал
- `year` - Год
- `custom` - Произвольный период (указать `start_date` и `end_date`)

#### Остатки по складам

Остатки товаров синхронизируются автоматически из `offers.xml` при синхронизации товаров.

**Ночная синхронизация остатков** (опционально, запускается автоматически):
```bash
# Настройка через переменные окружения:
STOCKS_SYNC_NIGHTLY_ENABLED=true
STOCKS_SYNC_NIGHTLY_HOUR=2
STOCKS_SYNC_NIGHTLY_MINUTE=0
ONEC_XML_OFFERS_URL=https://your-server.com/1c_exchange/uploaded/offers.xml
```

**Важно:** 
- Остатки синхронизируются только через CommerceML XML (`offers.xml`)
- OData методы синхронизации остатков удалены
- Остатки сохраняются в таблицу `product_stocks` при импорте товаров

## Логика синхронизации

### Товары (CommerceML XML)

При синхронизации товары сопоставляются по полю `external_id` (ID из XML):

- Если товар с таким `external_id` существует → обновляются все поля (если `update_existing=true`)
- Если товара нет → создается новый товар
- Если товар без `external_id` → пропускается

### Продажи (OData API)

Синхронизация продаж работает по следующей схеме:

1. **Запрос к 1С OData**: Получение данных о продажах за указанный период
2. **Сохранение в БД**: Данные сохраняются в таблицы `sales_records` и `sales_metrics`
3. **Кэширование**: Данные за прошлые периоды берутся из БД для быстрого доступа
4. **Обновление "сегодня"**: Данные за текущий день всегда запрашиваются онлайн из 1С
5. **Автоматическая синхронизация**: Если данных за период нет в БД, автоматически запрашивается из 1С

### Покупатели (OData API)

Синхронизация покупателей:

1. **Дисконтные карты**: Загрузка из `Catalog_ДисконтныеКарты`
2. **История покупок**: Загрузка из журналов продаж с привязкой к дисконтным картам
3. **Баллы лояльности**: Загрузка накопленных баллов (если доступно)

## Изображения товаров

Изображения загружаются из двух источников (в порядке приоритета):

1. **1С OData API**: Через mediaresource links из `Catalog_НоменклатураПрисоединенныеФайлы`
2. **YML файл**: Резервный источник из `https://glamejewelry.ru/tstore/yml/*.yml`

Для загрузки изображений используйте:

```bash
# Синхронизация изображений для всех товаров без изображений
POST /api/products/sync-images

# Синхронизация изображений для конкретного товара
POST /api/products/sync-images?product_id=uuid-товара
```

## Маппинг полей

### Товары (из CommerceML XML)

| Поле в XML | Поле в GLAME | Примечание |
|-----------|--------------|------------|
| `Ид` | `external_id` | Уникальный идентификатор в 1С |
| `Артикул` | `article` | Артикул товара |
| `Наименование` | `name` | Название товара |
| `Описание` | `description` | Краткое описание |
| `ОписаниеПолное` | `full_description` | Полное описание |
| `Группы/Ид` | `category` | Категория (по external_id группы) |
| `Картинка` | `images` | Массив URL изображений |
| `ХарактеристикиТовара` | `specifications` | Характеристики в формате JSONB |
| `Штрихкод` | `specifications.barcode` | Штрихкод |

### Продажи (из OData API)

| Поле в 1С | Поле в GLAME | Примечание |
|-----------|--------------|------------|
| `Period` | `sale_date` | Дата продажи |
| `Магазин_Key` | `store_id` | ID магазина |
| `Сумма` | `total_amount` | Сумма продажи |
| `СуммаСоСкидкой` | `discounted_amount` | Сумма со скидкой |
| `Количество` | `quantity` | Количество товаров |

## Автоматизация

### Переменные окружения для синхронизации

```env
# === 1C OData API (для покупателей и продаж) ===
ONEC_API_URL=https://msk1.1cfresh.com/a/sbm/3322419/odata/standard.odata
ONEC_API_TOKEN=b2RhdGEudXNlcjpvcGV4b2JvZQ==

# Endpoints
ONEC_SALES_ENDPOINT=/DocumentJournal_РозничныеПродажи
ONEC_CUSTOMERS_ENDPOINT=/Catalog_ДисконтныеКарты

# === Синхронизация покупателей (OData) ===
CUSTOMER_SYNC_ENABLED=true
CUSTOMER_SYNC_INTERVAL_HOURS=4
CUSTOMER_SYNC_RUN_ON_START=false
CUSTOMER_SYNC_CARDS_LIMIT=1000
CUSTOMER_SYNC_PURCHASE_DAYS=365

# === Ночная синхронизация покупателей (OData) ===
CUSTOMER_SYNC_NIGHTLY_ENABLED=true
CUSTOMER_SYNC_NIGHTLY_HOUR=3
CUSTOMER_SYNC_NIGHTLY_MINUTE=0
CUSTOMER_SYNC_NIGHTLY_CARDS_LIMIT=10000
CUSTOMER_SYNC_NIGHTLY_PURCHASE_DAYS=30

# === Ночная синхронизация остатков (OData) ===
STOCKS_SYNC_NIGHTLY_ENABLED=true
STOCKS_SYNC_NIGHTLY_HOUR=2
STOCKS_SYNC_NIGHTLY_MINUTE=0

# === Лояльность (OData) ===
ONEC_LOYALTY_ENABLED=true
```

### Автоматическая синхронизация

Система автоматически синхронизирует:

1. **Покупатели**: Каждые 4 часа (настраивается через `CUSTOMER_SYNC_INTERVAL_HOURS`)
2. **Ночная синхронизация покупателей**: Ежедневно в 03:00 (настраивается через `CUSTOMER_SYNC_NIGHTLY_HOUR`)
3. **Остатки по складам**: Ежедневно в 02:00 из `offers.xml` (настраивается через `STOCKS_SYNC_NIGHTLY_HOUR` и `ONEC_XML_OFFERS_URL`)
4. **Продажи**: По требованию (автоматически при запросе данных за период, если данных нет в БД)

**Товары синхронизируются вручную** через XML URL в UI или API.

## UI для синхронизации товаров

В разделе **"Каталог товаров"** (`/products`) доступна форма для синхронизации:

1. Выберите метод: **XML (CommerceML)**
2. Введите URL XML файла
3. Нажмите **"Синхронизировать"**
4. Отслеживайте прогресс в режиме реального времени

## Характеристики и варианты товаров

### Структура данных

В 1С товары могут иметь **характеристики** (варианты):

- **Основная карточка**: Товар с артикулом (например, `AG25055`)
- **Характеристики**: Варианты товара с разными цветами, размерами и т.д.
  - Артикул характеристики: основной артикул + суффикс (например, `AG25055-G` для золотого цвета)

### Отображение в UI

В карточке товара отображаются:

- **Основная информация**: Название, артикул, цена
- **Варианты**: Таблица с характеристиками (цвет, размер и т.д.)
- **Характеристики**: Материал, вставка, вес и другие свойства

## Изображения

Изображения загружаются из двух источников:

1. **1С OData API** (приоритет): Через `mediaresource` links
   - `Catalog_НоменклатураПрисоединенныеФайлы` - для основных карточек
   - `Catalog_ХарактеристикиНоменклатурыПрисоединенныеФайлы` - для характеристик

2. **YML файл** (резервный): Из `https://glamejewelry.ru/tstore/yml/*.yml`

### Синхронизация изображений

```bash
# Для всех товаров без изображений
POST /api/products/sync-images

# Для конкретного товара
POST /api/products/sync-images?product_id=uuid-товара
```

## Устранение проблем

### Товары не загружаются

1. Проверьте доступность XML файла по URL
2. Проверьте формат XML (должен соответствовать CommerceML)
3. Проверьте логи backend для деталей ошибок

### Изображения не загружаются

1. Проверьте настройки `ONEC_API_URL` и `ONEC_API_TOKEN`
2. Убедитесь, что в 1С есть присоединенные файлы к товарам
3. Используйте резервный YML источник

### Продажи не синхронизируются

1. Проверьте настройки OData API (`ONEC_API_URL`, `ONEC_API_TOKEN`)
2. Проверьте доступность endpoint `ONEC_SALES_ENDPOINT`
3. Убедитесь, что в 1С есть данные в `DocumentJournal_РозничныеПродажи`

### Задачи синхронизации исчезают

Задачи синхронизации хранятся в памяти и теряются при перезапуске сервера. После перезапуска:

1. Перейдите в раздел товаров
2. Запустите синхронизацию заново
3. Задачи будут созданы снова

## Рекомендации

1. **Первая синхронизация**: Используйте полный XML файл со всеми товарами
2. **Регулярная синхронизация**: Настройте автоматическую выгрузку XML в 1С (например, ежедневно)
3. **Мониторинг**: Регулярно проверяйте логи синхронизации
4. **Резервное копирование**: Делайте бэкап БД перед массовыми обновлениями
5. **Тестирование**: Сначала загрузите 10-20 тестовых товаров, затем полный каталог

## Дополнительные ресурсы

- [CHARACTERISTICS_LOADING_GUIDE.md](CHARACTERISTICS_LOADING_GUIDE.md) - Загрузка характеристик товаров
- [PRODUCT_GROUPS_FILTERING.md](PRODUCT_GROUPS_FILTERING.md) - Фильтрация по группам товаров
- [ANALYTICS_INTEGRATION_README.md](ANALYTICS_INTEGRATION_README.md) - Интеграция аналитики
- [SALES_SYNC_GUIDE.md](SALES_SYNC_GUIDE.md) - Руководство по синхронизации продаж
