# База знаний о бренде

## Обзор

База знаний о бренде GLAME хранится в векторной базе данных Qdrant и используется AI-агентами для генерации персонализированных рекомендаций и контента. Система автоматически создает embeddings для текстовых документов и позволяет выполнять семантический поиск по базе знаний.

## Способы загрузки

### 1. Загрузка PDF файлов (рекомендуется)

Система поддерживает автоматическое извлечение знаний из PDF документов с помощью AI. Просто загрузите PDF файл (брендбук, руководство, документация и т.д.), и система:

- Автоматически извлечет текст из PDF
- Использует AI для структурирования знаний
- Определит категории знаний
- Создаст векторные представления для поиска

**Через UI:**
1. Перейдите в раздел "База знаний"
2. Выберите PDF файл
3. Нажмите "Загрузить файл"
4. Система автоматически обработает документ

**Через API:**
```bash
curl -X POST "http://localhost:8000/api/knowledge/upload/file" \
  -F "file=@brand_guide.pdf"
```

### 2. Через API (JSON)

#### Загрузка через JSON запрос

```bash
curl -X POST "http://localhost:8000/api/knowledge/upload" \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {
        "text": "GLAME — это бренд украшений премиум-класса",
        "category": "brand_philosophy",
        "source": "brand_guide"
      },
      {
        "text": "Мы используем только качественные материалы",
        "category": "materials",
        "source": "product_specs"
      }
    ]
  }'
```

#### Загрузка из файла через API

```bash
curl -X POST "http://localhost:8000/api/knowledge/upload/file" \
  -F "file=@brand_knowledge.json"
```

Или через Swagger UI: http://localhost:8000/docs → `/api/knowledge/upload/file`

### 2. Через Python скрипт

```bash
cd backend
python load_brand_knowledge.py examples/brand_knowledge_example.json
```

## Форматы данных

### PDF файлы

Поддерживаются PDF документы любого размера. Система автоматически:
- Извлекает текст из всех страниц
- Разбивает текст на логические части
- Использует AI для извлечения структурированных знаний
- Определяет категории и источники

**Рекомендуемые типы документов:**
- Брендбуки и гайдлайны
- Руководства по стилю
- Описания продуктов и услуг
- Документация по ценностям бренда
- Маркетинговые материалы

### JSON файлы

Если у вас уже есть структурированные данные, можно загрузить их в формате JSON:

#### Вариант 1: Массив объектов

```json
[
  {
    "text": "Текст знания о бренде",
    "category": "brand_philosophy",
    "source": "brand_guide",
    "metadata": {
      "author": "Marketing Team",
      "date": "2024-01-15"
    }
  }
]
```

### Вариант 2: Объект с полем items

```json
{
  "items": [
    {
      "text": "Текст знания о бренде",
      "category": "materials"
    }
  ]
}
```

### Вариант 3: Массив строк

```json
[
  "Текст знания о бренде 1",
  "Текст знания о бренде 2"
]
```

## Поля документа

- **text** (обязательное): Текст знания о бренде
- **category** (опционально): Категория знания (например, "brand_philosophy", "materials", "service")
- **source** (опционально): Источник информации (например, "brand_guide", "product_specs")
- **metadata** (опционально): Дополнительные метаданные в виде объекта

## Поиск в базе знаний

### Через API

```bash
curl "http://localhost:8000/api/knowledge/search?query=качество%20материалов&limit=5"
```

### Параметры поиска

- `query` (обязательный): Текст запроса для поиска
- `limit` (опционально, по умолчанию 5): Количество результатов
- `score_threshold` (опционально, по умолчанию 0.5): Минимальный порог релевантности (0-1)

## Статистика

Получение статистики по базе знаний:

```bash
curl "http://localhost:8000/api/knowledge/stats"
```

Ответ:
```json
{
  "collection_name": "brand_philosophy",
  "total_documents": 15,
  "vector_size": 1536,
  "distance": "Cosine"
}
```

## Использование в коде

База знаний автоматически используется AI-агентами через метод `get_brand_context`:

```python
from app.services.vector_service import vector_service

# Поиск релевантного контекста
results = vector_service.get_brand_context("качество материалов", limit=3)

for result in results:
    print(f"Текст: {result['payload']['text']}")
    print(f"Релевантность: {result['score']}")
```

## Настройка

### Переменные окружения

Добавьте в файл `.env`:

```env
OPENAI_API_KEY=your_openai_api_key_here
QDRANT_URL=http://localhost:6333
QDRANT_API_KEY=your_qdrant_api_key_if_needed
```

**Важно:** Для создания embeddings необходим API ключ OpenAI. Без него загрузка и поиск не будут работать.

## Примеры категорий

Рекомендуемые категории для организации базы знаний:

- `brand_philosophy` - Философия и ценности бренда
- `materials` - Материалы и их характеристики
- `craftsmanship` - Процесс создания украшений
- `style` - Стилистика и дизайн
- `service` - Услуги и сервисы
- `collections` - Информация о коллекциях
- `values` - Ценности и принципы бренда
- `target_audience` - Целевая аудитория
- `use_cases` - Случаи использования
- `styling` - Стилизация и комбинирование
- `custom_orders` - Индивидуальные заказы

## Рекомендации

1. **Структурируйте знания**: Используйте категории для лучшей организации
2. **Добавляйте источники**: Указывайте источник информации для отслеживания
3. **Регулярно обновляйте**: Добавляйте новые знания по мере развития бренда
4. **Проверяйте качество**: Убедитесь, что тексты информативны и релевантны
5. **Тестируйте поиск**: Регулярно проверяйте, что поиск возвращает релевантные результаты

## Устранение проблем

### Ошибка: "OPENAI_API_KEY не установлен"

Добавьте переменную окружения `OPENAI_API_KEY` в файл `.env`.

### Ошибка: "Collection not found"

Коллекция создается автоматически при первом использовании. Если ошибка сохраняется, проверьте доступность Qdrant.

### Низкая релевантность результатов поиска

- Увеличьте `score_threshold` для более строгой фильтрации
- Проверьте качество текстов в базе знаний
- Убедитесь, что тексты достаточно информативны и содержат ключевые слова

## Примеры использования

### Загрузка из файла

```python
import requests

response = requests.post(
    "http://localhost:8000/api/knowledge/upload/file",
    files={"file": open("brand_knowledge.json", "rb")}
)

result = response.json()
print(f"Загружено: {result['uploaded_count']} документов")
```

### Поиск знаний

```python
import requests

response = requests.get(
    "http://localhost:8000/api/knowledge/search",
    params={
        "query": "качество материалов",
        "limit": 5,
        "score_threshold": 0.7
    }
)

results = response.json()
for item in results["results"]:
    print(f"{item['payload']['text']} (score: {item['score']:.2f})")
```
