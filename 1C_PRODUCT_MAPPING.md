# Маппинг товаров из 1С: Code vs Артикул

## Важно! Разница между полями

### Code (внутренний код 1С)
- **Поле в 1С:** `Code`
- **Примеры:** "НФ-00001248", "НФ-00001249", "00-00000308"
- **Что это:** Внутренний системный код товара в 1С
- **В нашей БД:** Сохраняется в поле `external_code`
- **Использование:** Для связи с 1С, но НЕ для отображения пользователям

### Артикул (реальный артикул товара)
- **Поле в 1С:** `Артикул`
- **Примеры:** "AG25059", "KL02204004", "U10029/40-45"
- **Что это:** Реальный артикул товара, который используется для продаж
- **В нашей БД:** Сохраняется в поле `article`
- **Использование:** Основной идентификатор для сопоставления товаров

### Ref_Key (UUID в 1С)
- **Поле в 1С:** `Ref_Key`
- **Примеры:** "15d539a2-ba46-11f0-836e-fa163e4cc04e"
- **Что это:** Уникальный идентификатор записи в 1С
- **В нашей БД:** Сохраняется в поле `external_id`
- **Использование:** Для уникальной идентификации товара в 1С

## Структура товаров с характеристиками

### Основная карточка (Parent)
```
Code: "00-00000308"
Артикул: NULL (или общий артикул)
Description: "AGafi"
Ref_Key: "b1b9a380-ba4b-11f0-836e-fa163e4cc04e"
IsFolder: false
Parent_Key: "00000000-0000-0000-0000-000000000000" (корневая)
```

### Характеристики (Children)
```
Code: "НФ-00001248"
Артикул: "AG25059"
Description: "Анклет AGafi (жемчуг, стекло)"
Ref_Key: "15d539a2-ba46-11f0-836e-fa163e4cc04e"
Parent_Key: "b1b9a380-ba4b-11f0-836e-fa163e4cc04e" (ссылка на основную карточку)
```

**Важно:** Характеристики - это отдельные записи в `Catalog_Номенклатура` с заполненным `Parent_Key`.

## Маппинг полей

### Текущий маппинг (исправлен)

| Поле 1С | Назначение | Поле в БД | Пример значения |
|---------|-----------|-----------|-----------------|
| `Ref_Key` | UUID товара в 1С | `external_id` | "15d539a2-ba46-11f0-836e-fa163e4cc04e" |
| `Code` | Внутренний код 1С | `external_code` | "НФ-00001248" |
| `Артикул` | Реальный артикул товара | `article` | "AG25059" |
| `Description` | Название товара | `name` | "Анклет AGafi (жемчуг, стекло)" |
| `НаименованиеПолное` | Полное название | - | Сохраняется в `onec_data` |

## Правила сопоставления товаров

При синхронизации товары сопоставляются в следующем порядке приоритета:

1. **По артикулу** (`article` = `Артикул` из 1С) - основной способ
2. **По external_code** (`external_code` = `Code` из 1С) - если артикула нет
3. **По external_id** (`external_id` = `Ref_Key` из 1С) - если ничего не найдено

## Обработка характеристик

### Вариант 1: Характеристики как отдельные товары
Характеристики хранятся как отдельные записи в `Catalog_Номенклатура` с:
- `Parent_Key` указывает на основную карточку
- Свой `Артикул` (например, "AG25059", "AG25059S", "AG25059G")
- Свой `Code` (например, "НФ-00001248")

**Текущая реализация:** Каждая характеристика синхронизируется как отдельный товар.

### Вариант 2: Catalog_ХарактеристикиНоменклатуры
Отдельная коллекция `Catalog_ХарактеристикиНоменклатуры` содержит:
- `Owner` - ссылка на основную номенклатуру
- `Артикул` - артикул характеристики (например, "U10029/40-45")
- `Description` - описание характеристики (цвет, размер и т.д.)

**Текущая реализация:** Пока не используется, но доступна для расширения.

## Примеры данных

### Пример 1: Товар с артикулом
```json
{
  "Code": "НФ-00001224",
  "Артикул": "KL02204004",
  "Description": "Браслет Kalliope жесткий с тонкими изгибами",
  "Ref_Key": "15d539a2-ba46-11f0-836e-fa163e4cc04e"
}
```

**Маппинг:**
- `external_id` = "15d539a2-ba46-11f0-836e-fa163e4cc04e"
- `external_code` = "НФ-00001224"
- `article` = "KL02204004"
- `name` = "Браслет Kalliope жесткий с тонкими изгибами"

### Пример 2: Основная карточка без артикула
```json
{
  "Code": "00-00000308",
  "Артикул": null,
  "Description": "AGafi",
  "Ref_Key": "b1b9a380-ba4b-11f0-836e-fa163e4cc04e",
  "Parent_Key": "00000000-0000-0000-0000-000000000000"
}
```

**Маппинг:**
- `external_id` = "b1b9a380-ba4b-11f0-836e-fa163e4cc04e"
- `external_code` = "00-00000308"
- `article` = null (нет артикула)
- `name` = "AGafi"

### Пример 3: Характеристика товара
```json
{
  "Code": "НФ-00001248",
  "Артикул": "AG25059",
  "Description": "Анклет AGafi (жемчуг, стекло)",
  "Ref_Key": "15d539a2-ba46-11f0-836e-fa163e4cc04e",
  "Parent_Key": "b1b9a380-ba4b-11f0-836e-fa163e4cc04e"
}
```

**Маппинг:**
- `external_id` = "15d539a2-ba46-11f0-836e-fa163e4cc04e"
- `external_code` = "НФ-00001248"
- `article` = "AG25059"
- `name` = "Анклет AGafi (жемчуг, стекло)"
- `specifications` может содержать `Parent_Key` для связи с основной карточкой

## Рекомендации

1. **Для сопоставления товаров:** Используйте `article` (Артикул), а не `external_code` (Code)
2. **Для связи с 1С:** Используйте `external_id` (Ref_Key) или `external_code` (Code)
3. **Для отображения:** Используйте `article` (Артикул) для пользователей
4. **Для характеристик:** Сохраняйте `Parent_Key` в `specifications` или создайте отдельное поле `parent_external_id`

## Проверка маппинга

Для проверки правильности маппинга запустите:

```bash
python backend/show_products_table.py
```

Скрипт покажет таблицу товаров с правильным разделением Code и Артикул.
